<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DIMS — Dominion1st Doctrines</title>
  <style>
    :root{--dom-blue:#0C1475; --icy1:#E6F0FF; --icy2:#A0CFFF; --icy3:#80BFFF; --text:#0b1220}
    html,body{margin:0;padding:0;background:#f7f9fc;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .layout{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    .sidebar{background:var(--dom-blue);color:#fff;padding:16px 12px}
    .brand{font-weight:800;letter-spacing:.3px;margin-bottom:12px}
    .nav-section-title{font-size:.9rem;opacity:.9;margin:14px 8px 6px}
    .nav-btn{display:block;width:100%;text-align:left;border:1px solid rgba(255,255,255,.2);border-radius:10px;background:transparent;color:#fff;padding:10px 12px;margin:6px 0;cursor:pointer}
    .nav-btn:hover{box-shadow:0 0 8px var(--icy1),0 0 16px var(--icy2),0 0 24px var(--icy3)}
    .nav-btn.primary{background:rgba(255,255,255,.06)}
    .content{padding:16px 18px}
    .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .toolbar .spacer{flex:1 1 auto}
    .btn{background:var(--dom-blue);color:#fff;border:1px solid rgba(0,0,0,.1);border-radius:10px;padding:8px 12px;cursor:pointer;text-decoration:none;display:inline-block}
    .btn:hover{box-shadow:0 0 8px var(--icy1),0 0 16px var(--icy2),0 0 24px var(--icy3)}
    .title{width:100%;font-size:1.15rem;margin:6px 0}
    .split{display:grid;grid-template-columns:310px 1fr;gap:14px}
    .list{background:#fff;border:1px solid #e6e9ef;border-radius:12px;overflow:auto;max-height:calc(100vh - 160px)}
    .search{display:flex;gap:8px;padding:8px;border-bottom:1px solid #e6e9ef}
    .search input{flex:1;border:1px solid #d5dbe6;border-radius:10px;padding:8px 10px}
    .row{padding:10px 12px;border-bottom:1px solid #f0f3f7;cursor:pointer}
    .row:hover{background:#f5f8ff}
    .row .t{font-weight:700}
    .row .m{font-size:.9rem;color:#5b6b7a;margin-top:2px}
    mark{background:linear-gradient(90deg, rgba(230,240,255,.9), rgba(160,207,255,.7));border-radius:4px;padding:0 2px}
    .editor-card{background:#fff;border:1px solid #e6e9ef;border-radius:12px;padding:12px}
    .preview{border:1px solid #e6e9ef;border-radius:12px;padding:12px;margin-top:10px;background:#fff}
    h2,h3{color:var(--dom-blue);text-shadow:0 0 6px var(--icy1)}
    .meta{color:#5b6b7a}
    @media print{ .sidebar,.toolbar,.list,.title,.search,.btn{display:none !important} body{background:#fff} .preview{border:none;padding:0} }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">DIMS</div>
      <div class="nav-section-title">Tier</div>
      <button class="nav-btn">Tier 1</button>
      <button class="nav-btn">Tier 2</button>
      <button class="nav-btn">Tier 3</button>
      <div class="nav-section-title">Streams</div>
      <button id="nav-teachings" class="nav-btn primary">📜 Dominion1st Doctrines</button>
    </aside>

    <main class="content">
      <div class="toolbar">
        <h2 style="margin:0">📜 Dominion1st Doctrines</h2>
        <div class="spacer"></div>
        <a class="btn" id="btn-back" href="/">← Back to Dashboard</a>
      </div>

      <div class="toolbar">
        <a class="btn" id="btn-new">New</a>
        <a class="btn" id="btn-save">Save</a>
        <a class="btn" id="btn-prev">Preview</a>
        <a class="btn" id="btn-print">Print</a>
        <div class="spacer"></div>
        <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="chk-public"> Public</label>
      </div>

      <div class="split">
        <section class="list">
          <div class="search">
            <input id="q" placeholder="Search title, tag, scripture…">
          </div>
          <div id="list"></div>
        </section>

        <section class="editor-card">
          <input id="title" class="title" placeholder="Title">
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <select id="status">
              <option value="open">🟢 Open</option>
              <option value="in_progress">🟡 In Progress</option>
              <option value="closed">🔴 Closed</option>
            </select>
            <select id="priority">
              <option value="high">👑 High</option>
              <option value="medium">🛡 Medium</option>
              <option value="low">🚋 Low</option>
            </select>
            <input id="tags" placeholder="tags (comma separated)" style="flex:1">
          </div>
          <textarea id="md" rows="16" placeholder="Use Markdown. Italicize scripture and include refs in parentheses." style="width:100%"></textarea>
          <div id="preview" class="preview" style="display:none"></div>
        </section>
      </div>
    </main>
  </div>

<script>
(function(){
  function $(s){return document.querySelector(s)}
  const listEl = $('#list'); const searchEl = $('#q');

  let TEACHINGS = []; let currentId = null;

  async function load(){
    try{
      const res = await fetch('teachings.json', {cache:'no-store'});
      const data = await res.json();
      TEACHINGS = data.teachings || [];
    }catch(e){ TEACHINGS = []; }
    renderList();
    const preferred = TEACHINGS.find(t=>t.id==='tch-created-in-his-image') || TEACHINGS[0];
    if(preferred) setEditor(preferred);
  }

  function statusBadge(s){ return s==='open'?'🟢 Open':s==='in_progress'?'🟡 In Progress':'🔴 Closed';}
  function prioBadge(p){ return p==='high'?'👑 High':p==='medium'?'🛡 Medium':'🚋 Low';}

  function renderList(){
    const q = (searchEl.value||'').trim().toLowerCase();
    listEl.innerHTML = '';
    const items = TEACHINGS
      .filter(t => !q || [t.title, ...(t.tags||[]), ...(t.scriptures||[]).map(s=>s.ref)].join(' ').toLowerCase().includes(q))
      .sort((a,b)=>a.title.localeCompare(b.title));
    items.forEach(t=>{
      const el = document.createElement('div');
      el.className = 'row'; el.dataset.id = t.id;
      const title = highlight(t.title, q);
      const meta = `${statusBadge(t.status)} · ${prioBadge(t.priority)} · ${t.public?'🌐 Public':'🔒 Private'}`;
      el.innerHTML = `<div class="t">${title}</div><div class="m">${meta}</div>`;
      el.addEventListener('click', ()=>setEditor(t));
      listEl.appendChild(el);
    });
  }

  function highlight(text, q){
    if(!q) return escapeHTML(text);
    const re = new RegExp('('+escapeReg(q)+')','ig');
    return escapeHTML(text).replace(re,'<mark>$1</mark>');
  }
  function escapeHTML(str){ return (str||'').replace(/[&<>"]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s])); }
  function escapeReg(str){ return str.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') }

  function setEditor(t){
    currentId = t.id;
    $('#title').value = t.title||'';
    $('#status').value = t.status||'open';
    $('#priority').value = t.priority||'high';
    $('#tags').value = (t.tags||[]).join(', ');
    $('#md').value = t.content_md||'';
    $('#chk-public').checked = !!t.public;
    $('#preview').style.display = 'none';
  }

  function getEditor(){
    return {
      id: currentId,
      title: $('#title').value.trim(),
      status: $('#status').value,
      priority: $('#priority').value,
      tags: ($('#tags').value||'').split(',').map(s=>s.trim()).filter(Boolean),
      content_md: $('#md').value,
      public: $('#chk-public').checked,
      updated_at: new Date().toISOString()
    };
  }

  function save(){
    const draft = getEditor();
    localStorage.setItem('dims_teaching_'+draft.id, JSON.stringify(draft));
    const i = TEACHINGS.findIndex(x=>x.id===draft.id);
    if(i>=0) TEACHINGS[i] = Object.assign(TEACHINGS[i], draft);
    else TEACHINGS.push(draft);
    renderList();
    alert('Teaching saved locally. (Publishing to file requires a build/deploy step.)');
  }

  function md2html(md){
    return (md||'')
      .replace(/^### (.*)$/gm,'<h3>$1</h3>')
      .replace(/^## (.*)$/gm,'<h2>$1</h2>')
      .replace(/^# (.*)$/gm,'<h1>$1</h1>')
      .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
      .replace(/\*(.*?)\*/g,'<em>$1</em>')
      .replace(/\n/g,'<br>');
  }

  function preview(){
    const t = getEditor();
    const html = md2html(t.content_md);
    const scr = (t.scriptures||[]).map(s=>`<li><em>${escapeHTML(s.text)}</em> <span>(${escapeHTML(s.ref)})</span></li>`).join('');
    const scrBlock = scr ? `<section><h3>Scriptures</h3><ul>${scr}</ul></section>` : '';
    $('#preview').innerHTML = `<article><header><h2>${escapeHTML(t.title)||'(Untitled Teaching)'} </h2>
      <div class="meta">${statusBadge(t.status)} · ${prioBadge(t.priority)} · ${$('#chk-public').checked?'🌐 Public':'🔒 Private'}</div></header>${scrBlock}<section>${html}</section></article>`;
    $('#preview').style.display = 'block';
  }

  function printIt(){ preview(); window.print(); }

  document.addEventListener('DOMContentLoaded', ()=>{
    load();
    $('#btn-new').addEventListener('click', ()=>{
      const t = {id:'tch-'+Date.now(), title:'', status:'open', priority:'high', tags:[], scriptures:[], content_md:'', public:false};
      TEACHINGS.push(t); renderList(); setEditor(t);
    });
    $('#btn-save').addEventListener('click', save);
    $('#btn-prev').addEventListener('click', preview);
    $('#btn-print').addEventListener('click', printIt);
  });
})();
</script>
</body>
</html>
